@inherits LayoutComponentBase
@using Microsoft.FluentUI.AspNetCore.Components
@using Flux.Infrastructure.Client
@using Flux.Domain.Entities
@inject WorkspaceStateService WorkspaceState
@inject NavigationManager Navigation
@implements IDisposable

<div class="main-container">
    <div class="slack-layout">
        <!-- 1. Activity Bar -->
        <div class="activity-bar">
            <FluentTooltip Anchor="ws-icon" Position="TooltipPosition.Right">Workspaces</FluentTooltip>
            <div id="ws-icon" class="activity-item" @onclick='() => Navigation.NavigateTo("/")'>
                <FluentIcon Value="@(new Icons.Regular.Size32.Home())" Color="Color.Fill" />
            </div>

            <FluentTooltip Anchor="dm-icon" Position="TooltipPosition.Right">Direct Messages</FluentTooltip>
            <div id="dm-icon" class="activity-item active">
                <FluentIcon Value="@(new Icons.Regular.Size32.Chat())" Color="Color.Fill" />
            </div>

            <FluentTooltip Anchor="alert-icon" Position="TooltipPosition.Right">Activity</FluentTooltip>
            <div id="alert-icon" class="activity-item">
                <FluentIcon Value="@(new Icons.Regular.Size32.Alert())" Color="Color.Fill" />
            </div>

            <FluentSpacer />

            <FluentTooltip Anchor="profile-icon" Position="TooltipPosition.Right">Profile</FluentTooltip>
            <div id="profile-icon" style="padding-bottom: 12px; cursor: pointer;">
                <FluentPersona Status="PresenceStatus.Available" ImageSize="36px" Initials="JD" />
            </div>
        </div>

        <!-- 2. Workspace Sidebar -->
        <div class="workspace-sidebar">
            <div class="sidebar-header">
                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="10">
                    <span style="font-size: 1.1rem; letter-spacing: -0.5px; font-weight: 600;">Flux Workspace</span>
                    <FluentSpacer />
                    <FluentIcon Value="@(new Icons.Regular.Size20.ChevronDown())" />
                </FluentStack>
            </div>
            
            <div style="flex: 1; overflow-y: auto; padding: 10px 0;">
                <FluentNavMenu Width="260">
                    <FluentNavGroup Title="Channels" Icon="@(new Icons.Regular.Size20.CaretDown())" Expanded="true">
                        @foreach (var channel in WorkspaceState.Channels)
                        {
                            var icon = channel.Type == ChannelType.Private 
                                ? (Icon)new Icons.Regular.Size16.LockClosed() 
                                : (Icon)new Icons.Regular.Size16.Tag();
                                
                            <FluentNavLink Icon="@icon" 
                                           Href="@($"/workspace/{WorkspaceState.CurrentWorkspaceId}/channel/{channel.Id}")">
                                @channel.Name
                            </FluentNavLink>
                        }
                        <FluentNavLink Icon="@(new Icons.Regular.Size16.Add())" Style="opacity: 0.7;">Add Channels</FluentNavLink>
                    </FluentNavGroup>

                    <FluentNavGroup Title="Direct Messages" Icon="@(new Icons.Regular.Size20.CaretDown())" Expanded="true" Style="margin-top: 20px;">
                        <FluentNavLink Icon="@(new Icons.Regular.Size16.Person())">John Doe (You)</FluentNavLink>
                        <FluentNavLink Icon="@(new Icons.Regular.Size16.Person())">Jane Smith</FluentNavLink>
                    </FluentNavGroup>
                </FluentNavMenu>
            </div>
        </div>

        <!-- 3. Main Content -->
        <div class="main-content">
            @Body
        </div>
    </div>
</div>

<FluentToastProvider />
<FluentDialogProvider />
<FluentTooltipProvider />
<FluentMenuProvider />

@code {
    private static readonly Guid CurrentUserId = Guid.Parse("00000000-0000-0000-0000-000000000001");

    protected override void OnInitialized()
    {
        WorkspaceState.OnStateChanged += StateHasChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        // Try to extract WorkspaceId from the URL
        var uri = Navigation.Uri;
        var parts = uri.Split('/');
        int wsIndex = Array.IndexOf(parts, "workspace");
        
        if (wsIndex != -1 && wsIndex + 1 < parts.Length)
        {
            if (Guid.TryParse(parts[wsIndex + 1], out Guid workspaceId))
            {
                await WorkspaceState.LoadWorkspaceAsync(workspaceId, CurrentUserId);
            }
        }
    }

    public void Dispose()
    {
        WorkspaceState.OnStateChanged -= StateHasChanged;
    }
}
