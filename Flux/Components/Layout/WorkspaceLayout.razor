@inherits LayoutComponentBase
@using Flux.Domain.Entities
@using Flux.Features.Channels.CreateChannel
@inject WorkspaceStateService WorkspaceState
@inject NavigationManager Navigation
@inject FluxClientService FluxService
@inject IDialogService DialogService
@implements IDisposable

<div class="main-container">
    <div class="slack-layout">
        <!-- 1. Activity Bar (Narrow Left) -->
        <div class="activity-bar">
            <div class="activity-top">
                <FluentTooltip Anchor="home-icon" Position="TooltipPosition.Right">Home</FluentTooltip>
                <div id="home-icon" class="activity-item @(IsActive("/") ? "active" : "")" @onclick='() => Navigation.NavigateTo("/")'>
                    <FluentIcon Value="@(new Icons.Regular.Size28.Home())" />
                </div>

                <FluentTooltip Anchor="chat-icon" Position="TooltipPosition.Right">DMs</FluentTooltip>
                <div id="chat-icon" class="activity-item @(IsActive("/dms") ? "active" : "")">
                    <FluentIcon Value="@(new Icons.Regular.Size28.Chat())" />
                </div>

                <FluentTooltip Anchor="activity-icon" Position="TooltipPosition.Right">Activity</FluentTooltip>
                <div id="activity-icon" class="activity-item">
                    <FluentIcon Value="@(new Icons.Regular.Size28.Alert())" />
                </div>
                
                <FluentTooltip Anchor="more-icon" Position="TooltipPosition.Right">More</FluentTooltip>
                <div id="more-icon" class="activity-item">
                    <FluentIcon Value="@(new Icons.Regular.Size28.MoreHorizontal())" />
                </div>
            </div>

            <FluentSpacer />

            <div class="activity-bottom">
                <FluentTooltip Anchor="profile-icon" Position="TooltipPosition.Right">Profile</FluentTooltip>
                <div id="profile-icon" class="profile-item">
                    <FluentPersona Status="PresenceStatus.Available" ImageSize="32px" Initials="JD" />
                </div>
            </div>
        </div>

        <!-- 2. Workspace Sidebar (Channels/DMs) -->
        <div class="workspace-sidebar">
            <div class="sidebar-header">
                <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
                    <div class="workspace-name">
                        <FluentLabel Typo="Typography.Body" Style="font-weight: 800;">Flux Workspace</FluentLabel>
                    </div>
                    <FluentSpacer />
                    <FluentButton Appearance="Appearance.Stealth" IconEnd="@(new Icons.Regular.Size16.ChevronDown())" />
                </FluentStack>
            </div>
            
            <div class="sidebar-scrollable">
                <FluentNavMenu Width="260">
                    <FluentNavGroup Title="Channels" Icon="@(new Icons.Regular.Size20.CaretDown())" Expanded="true">
                        @foreach (var channel in WorkspaceState.Channels)
                        {
                            var icon = channel.Type == ChannelType.Private 
                                ? (Icon)new Icons.Regular.Size16.LockClosed() 
                                : (Icon)new Icons.Regular.Size16.Tag();
                                
                            <FluentNavLink Icon="@icon" 
                                           Href="@($"/workspace/{WorkspaceState.CurrentWorkspaceId}/chat/{channel.Id}")"
                                           Match="NavLinkMatch.All">
                                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                    <span>@channel.Name</span>
                                    <FluentButton Appearance="Appearance.Stealth" 
                                                  IconEnd="@(new Icons.Regular.Size16.Dismiss())" 
                                                  OnClick="@(() => ConfirmDeleteChannel(channel.Id, channel.Name))"
                                                  OnClick:stopPropagation="true"
                                                  Style="height: 20px; width: 20px; padding: 0; min-width: 0;" />
                                </div>
                            </FluentNavLink>
                        }
                        <FluentNavLink Icon="@(new Icons.Regular.Size16.Add())" 
                                       Style="opacity: 0.8; font-style: italic;"
                                       OnClick="() => _hideCreateChannelDialog = false">
                            Add Channels
                        </FluentNavLink>
                    </FluentNavGroup>

                    <FluentNavGroup Title="Direct Messages" Icon="@(new Icons.Regular.Size20.CaretDown())" Expanded="true" Style="margin-top: 16px;">
                        <FluentNavLink Icon="@(new Icons.Regular.Size16.Person())">John Doe (You)</FluentNavLink>
                        <FluentNavLink Icon="@(new Icons.Regular.Size16.Person())">Jane Smith</FluentNavLink>
                    </FluentNavGroup>
                </FluentNavMenu>
            </div>
        </div>

        <!-- 3. Main Content -->
        <div class="main-content">
            @Body
        </div>
    </div>
</div>

<FluentDialog @bind-Hidden="_hideCreateChannelDialog" Modal="true" TrapFocus="true" @onclick:stopPropagation>
    <div style="padding: 24px; width: 400px;">
        <FluentLabel Typo="Typography.H3">Create a Channel</FluentLabel>
        <div style="margin-top: 20px;">
            <FluentTextField Label="Name" @bind-Value="_newChannelName" Placeholder="# e.g. marketing" Style="width: 100%;" />
        </div>
        <div style="margin-top: 15px;">
            <FluentTextArea Label="Description (Optional)" @bind-Value="_newChannelDescription" Style="width: 100%;" />
        </div>
        <div style="margin-top: 15px;">
            <FluentSelect TOption="string" Label="Channel Type" @bind-Value="_newChannelTypeString" Style="width: 100%;">
                <FluentOption TOption="string" Value="Public">Public</FluentOption>
                <FluentOption TOption="string" Value="Private">Private</FluentOption>
            </FluentSelect>
        </div>
        <div style="margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px;">
            <FluentButton Appearance="Appearance.Neutral" OnClick="() => _hideCreateChannelDialog = true">Cancel</FluentButton>
            <FluentButton Appearance="Appearance.Accent" OnClick="CreateChannel" Disabled="@(string.IsNullOrWhiteSpace(_newChannelName))">Create</FluentButton>
        </div>
    </div>
</FluentDialog>

<style>
    .activity-top {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        width: 100%;
    }

    .activity-bottom {
        padding-bottom: 16px;
    }

    .profile-item {
        cursor: pointer;
        padding: 4px;
        border-radius: 8px;
        transition: background-color 0.2s;
    }

    .profile-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .workspace-name {
        padding-left: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .sidebar-scrollable {
        flex: 1; 
        overflow-y: auto; 
        padding: 8px 0;
    }

    /* Override Fluent UI styles to match Slack-like dark activity bar */
    .activity-bar fluent-icon {
        fill: rgba(255, 255, 255, 0.7) !important;
    }

    .activity-item.active fluent-icon {
        fill: white !important;
    }

    .activity-item:hover fluent-icon {
        fill: white !important;
    }

    /* Show delete button on hover */
    .workspace-sidebar fluent-nav-link:hover .fluent-button {
        opacity: 1 !important;
    }
    
    .workspace-sidebar .fluent-button {
        opacity: 0;
        transition: opacity 0.2s;
    }
</style>

@code {
    private static readonly Guid CurrentUserId = Guid.Parse("00000000-0000-0000-0000-000000000001");
    private bool _hideCreateChannelDialog = true;
    private string _newChannelName = "";
    private string _newChannelDescription = "";
    private string _newChannelTypeString = "Public";

    protected override void OnInitialized()
    {
        WorkspaceState.OnStateChanged += StateHasChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        var uri = Navigation.Uri;
        var parts = uri.Split('/');
        int wsIndex = Array.IndexOf(parts, "workspace");
        
        if (wsIndex != -1 && wsIndex + 1 < parts.Length)
        {
            if (Guid.TryParse(parts[wsIndex + 1], out Guid workspaceId))
            {
                await WorkspaceState.LoadWorkspaceAsync(workspaceId, CurrentUserId);
            }
        }
    }

    private bool IsActive(string href)
    {
        var relative = Navigation.ToBaseRelativePath(Navigation.Uri);
        if (string.IsNullOrEmpty(relative) && href == "/") return true;
        return relative.StartsWith(href.TrimStart('/'));
    }

    private async Task CreateChannel()
    {
        if (string.IsNullOrWhiteSpace(_newChannelName) || WorkspaceState.CurrentWorkspaceId == null) return;

        var type = _newChannelTypeString == "Public" ? ChannelType.Public : ChannelType.Private;
        var request = new CreateChannelRequest(_newChannelName, _newChannelDescription, type, CurrentUserId);
        
        var result = await FluxService.CreateChannelAsync(WorkspaceState.CurrentWorkspaceId.Value, request);
        if (result.IsSuccess)
        {
            _newChannelName = "";
            _newChannelDescription = "";
            _hideCreateChannelDialog = true;
            await WorkspaceState.RefreshChannelsAsync(CurrentUserId);
        }
    }

    private async Task ConfirmDeleteChannel(Guid channelId, string channelName)
    {
        var dialog = await DialogService.ShowConfirmationAsync(
            $"Are you sure you want to delete #{channelName}? This will delete all messages.",
            "Delete Channel", "Delete", "Cancel");
        
        var result = await dialog.Result;
        if (!result.Cancelled && WorkspaceState.CurrentWorkspaceId != null)
        {
            var deleteResult = await FluxService.DeleteChannelAsync(WorkspaceState.CurrentWorkspaceId.Value, channelId, CurrentUserId);
            if (deleteResult.IsSuccess)
            {
                await WorkspaceState.RefreshChannelsAsync(CurrentUserId);
                // If we're on the chat page for this channel, go to dashboard
                if (Navigation.Uri.Contains(channelId.ToString()))
                {
                    Navigation.NavigateTo($"/workspace/{WorkspaceState.CurrentWorkspaceId}/dashboard");
                }
            }
        }
    }

    public void Dispose()
    {
        WorkspaceState.OnStateChanged -= StateHasChanged;
    }
}
