@page "/"
@inject NavigationManager Navigation
@inject FluxClientService FluxService

<div style="padding: 40px; max-width: 1200px; margin: 0 auto;">
    
    @* Flux Introduction Section *@
    <div style="text-align: center; margin-bottom: 60px;">
        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.Center" VerticalAlignment="VerticalAlignment.Center" HorizontalGap="15">
            <div style="background-color: var(--accent-fill-rest); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <FluentIcon Value="@(new Icons.Regular.Size32.Chat())" Color="Color.Fill" />
            </div>
            <FluentLabel Typo="Typography.H1" Style="margin: 0;">Flux</FluentLabel>
        </FluentStack>
        
        <FluentLabel Typo="Typography.H3" Style="margin-top: 15px; opacity: 0.8;">Unified Communication & Task Management</FluentLabel>
        <FluentLabel Typo="Typography.Body" Style="margin-top: 10px; max-width: 600px; margin-left: auto; margin-right: auto;">
            Experience a new way of collaborating. Connect with your team, manage channels, and transform messages into actionable tasks seamlessly.
        </FluentLabel>
    </div>

    <FluentDivider Style="margin-bottom: 50px;" />

    @* Create WorkSpace *@
    @if (_workspaces == null)
    {
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px;">
            <FluentProgressRing />
            <FluentLabel Style="margin-top: 15px;">Finding your workspaces...</FluentLabel>
        </div>
    }
    else
    {
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            @foreach (var workspace in _workspaces)
            {
                <FluentCard Style="padding: 20px; cursor: pointer; transition: transform 0.2s;" @onclick="() => SelectWorkspace(workspace)">
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
                        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="10">
                            <div style="background-color: var(--neutral-layer-2); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                @(workspace.Name?.Length > 0 ? workspace.Name[0].ToString().ToUpper() : "?")
                            </div>
                            <FluentLabel Typo="Typography.H4" Style="margin: 0;">@workspace.Name</FluentLabel>
                        </FluentStack>
                        
                        <FluentLabel Typo="Typography.Body" Style="height: 40px; overflow: hidden; text-overflow: ellipsis;">
                            @workspace.Description
                        </FluentLabel>

                        <FluentDivider />

                        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
                            <div @onclick:stopPropagation="true">
                                <FluentButton Appearance="Appearance.Stealth" 
                                              IconStart="@(new Icons.Regular.Size16.Delete())" 
                                              Color="Color.Error" 
                                              OnClick="() => DeleteWorkspace(workspace)">
                                </FluentButton>
                            </div>
                            <FluentButton Appearance="Appearance.Stealth" IconEnd="@(new Icons.Regular.Size16.ArrowRight())">Enter Workspace</FluentButton>
                        </FluentStack>
                    </FluentStack>
                </FluentCard>
            }

            <FluentCard Style="padding: 20px; border: 2px dashed var(--neutral-stroke-rest); background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer;" 
                        @onclick="() => _showCreateDialog = true">
                <FluentStack Orientation="Orientation.Vertical" VerticalAlignment="VerticalAlignment.Center" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="10">
                    <FluentIcon Value="@(new Icons.Regular.Size32.Add())" Color="Color.Neutral" />
                    <FluentLabel Typo="Typography.Body">Create Workspace</FluentLabel>
                </FluentStack>
            </FluentCard>
        </div>
    }
</div>

@* Create Workspace Dialog Placeholder *@
<FluentDialog Hidden="!_showCreateDialog" Modal="true" TrapFocus="true" @onclick:stopPropagation>
    <div style="padding: 20px; width: 400px;">
        <FluentLabel Typo="Typography.H3">New Workspace</FluentLabel>
        <div style="margin-top: 20px;">
            <FluentTextField Label="Workspace Name" @bind-Value="_newWorkspaceName" Style="width: 100%;" />
        </div>
        <div style="margin-top: 15px;">
            <FluentTextArea Label="Description" @bind-Value="_newWorkspaceDescription" Style="width: 100%;" />
        </div>
        <div style="margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px;">
            <FluentButton Appearance="Appearance.Neutral" OnClick="() => _showCreateDialog = false">Cancel</FluentButton>
            <FluentButton Appearance="Appearance.Accent" OnClick="CreateWorkspace">Create</FluentButton>
        </div>
    </div>
</FluentDialog>

@code {
    private List<WorkspaceSummary>? _workspaces;
    
    // Hardcoded for now
    private static readonly Guid CurrentUserId = Guid.Parse("00000000-0000-0000-0000-000000000001");

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkspaces();
    }

    private async Task LoadWorkspaces()
    {
        try 
        {
            var result = await FluxService.GetWorkspacesAsync(CurrentUserId);
            if (result.IsSuccess)
            {
                _workspaces = result.Value ?? new();
                Console.WriteLine($"Successfully loaded {_workspaces.Count} workspaces.");
            }
            else
            {
                Console.WriteLine($"Error loading workspaces: {result.Error}");
                _workspaces = new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception loading workspaces: {ex.Message}");
            _workspaces = new();
        }
    }

    private bool _showCreateDialog = false;
    private string _newWorkspaceName = "";
    private string _newWorkspaceDescription = "";

    private void SelectWorkspace(WorkspaceSummary workspace)
    {
        Navigation.NavigateTo($"/workspace/{workspace.Id}/dashboard");
    }

    private async Task DeleteWorkspace(WorkspaceSummary workspace)
    {
        var result = await FluxService.DeleteWorkspaceAsync(workspace.Id, CurrentUserId);
        if (result.IsSuccess)
        {
            await LoadWorkspaces();
        }
    }

    private async Task CreateWorkspace()
    {
        if (string.IsNullOrWhiteSpace(_newWorkspaceName)) return;
        
        var result = await FluxService.CreateWorkspaceAsync(CurrentUserId, _newWorkspaceName, _newWorkspaceDescription);
        
        if (result.IsSuccess)
        {
            _newWorkspaceName = "";
            _newWorkspaceDescription = "";
            _showCreateDialog = false;
            await LoadWorkspaces();
        }
    }
}
